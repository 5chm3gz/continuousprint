<div class="cp-header">
  <h3>Continuous Print Queue</h3>
  <button class="btn btn-secondary" data-bind="visible: active(), click: function() {setActive(false);}">
    <i class="fa fa-stop"></i>&nbsp;&nbsp;Stop Managing
  </button>
  <button class="btn btn-primary" data-bind="hidden: active(), click: function() {setActive(true);}">
    <i class="fa fa-play"></i>&nbsp;&nbsp;Start Managing
  </button>
</div>

<span data-bind="visible:  active()"><i class="fa fa-spinner fa-spin" data-bind="visible: active()"></i></span>
<strong data-bind="text: status"></strong>
<hr/>


<div class="action_bar">
  <div class="btn-group">
    <button class="btn" data-bind="click: newEmptyJob"><i style="cursor:pointer" class="fas fa-plus"></i></button>
    <button class="btn" data-bind="click: refreshQueue"><i style="cursor: pointer" class="fas fa-sync"></i></button>
  </div>

  <div class="pull-right btn-group">
    <button class="btn" data-bind="visible: checkFraction() > 0, click: deleteSelected">
      <i style="cursor: pointer" class="far fa-trash-alt"></i>
    </button>
    <button class="btn" data-bind="visible: checkFraction() > 0, click: resetSelected">
      <i style="cursor: pointer" class="fas fa-redo"></i>
    </button>
    <a class="btn dropdown-toggle" data-toggle="dropdown">
      <i style="cursor: pointer" data-bind="click: onChecked, css: (checkFraction() >= 1) ? 'fas fa-check-square' : ((checkFraction() > 0) ? 'fas fa-minus-square' : 'far fa-square')"></i>
      <i style="cursor: pointer" class="fa fa-caret-down"></i>
    </a>
    <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu">
      <li><a tabindex="-1" data-bind="click: batchSelect">All</a></li>
      <li><a tabindex="-1" data-bind="click: batchSelect">None</a></li>
      <li class="divider"></li>
      <li><a tabindex="-1" data-bind="click: batchSelect">Empty Jobs</a></li>
      <li><a tabindex="-1" data-bind="click: batchSelect">Unstarted Jobs</a></li>
      <li><a tabindex="-1" data-bind="click: batchSelect">Incomplete Jobs</a></li>
      <li><a tabindex="-1" data-bind="click: batchSelect">Completed Jobs</a></li>
      <li class="divider"></li>
      <li><a tabindex="-1" data-bind="click: batchSelect">Unstarted Sets</a></li>
      <li><a tabindex="-1" data-bind="click: batchSelect">Incomplete Sets</a></li>
      <li><a tabindex="-1" data-bind="click: batchSelect">Completed Sets</a></li>
    </ul>
  </div>
</div>

<div class="queue-header">
  <div style="flex:1">Job</div>
  <div style="width: 150px">Progress</div>
  <div class="repeats">Count</div>
  <div class="total">Total</div>
</div>
<!-- `cpsortable` is renamed from `sortable` - see https://github.com/smartin015/continuousprint/issues/14 -->
<div id="queue_list" class="accordion" data-bind="cpsortable: {foreach: jobs, options: {handle: '.fa-grip-lines-vertical', onStart: $root.sortStart, onEnd: $root.sortEnd, onMove: $root.sortMove}}, css: {'loading': $root.loading()}">
  <div class="accordion-group job">
    <div class="accordion-heading job-header">
      <div class="queue-row-container">
        <i class="fas fa-grip-lines-vertical"></i>
        <!-- _vkenabled fixes dynamic form bug on virtual keyboard: https://github.com/xontab/chrome-virtual-keyboard/issues/5 -->
        <input type="text" class="job-name" data-bind="textInput: name, event: { change: $root.setJobName }, attr: {'_vkenabled': false}" placeholder="Click here to name"></input>
        <div class="progress">
          <div data-bind="style: { width: pct_complete() }" class="bar bar-success"></div>
        </div>
        <div class="repeats">
          <span data-bind="text: (count()-remaining()) + ' /'">/</span>
          <!-- _vkenabled fixes dynamic form bug on virtual keyboard: https://github.com/xontab/chrome-virtual-keyboard/issues/5 -->
          <input class="fa fa-text count-box" type="number" data-bind="value: countInput, event: { change: $root.setCount }, attr: {'_vkenabled': false}"></input>
        </div>
        <div class="total" data-bind="text: length_completed() + '/' + length()"></div>
        <div class="accordion-heading-button pull-right" data-bind="click: onChecked">
          <i style="cursor: pointer" data-bind="css: selected() ? 'fas fa-check-square' : 'far fa-square'"></i>
        </div>
      </div>
    </div>

    <div class="accordion-body collapse in">
      <div class="accordion-inner">
        <div id="queue_sets" data-bind="cpsortable: {foreach: sets, as: 'set', options: {handle: '.fa-grip-lines-vertical', onStart: $root.sortStart, onEnd: $root.sortEnd, onMove: $root.sortMove, group: 'sets'}}, css: {'empty': sets().length < 1}" class="sets accordion">
          <div class="accordion-group">
            <div class="accordion-heading">
                <div class="queue-row-container">
                  <i class="fas fa-grip-lines-vertical"></i>
                  <p class="file-name" style="cursor:pointer" data-bind="click: () => $root.setSelected($parentContext.$index, $index), style: { 'font-weight': $root.active_set() == id ? 'bold': null }">
                    <i class="fa" data-bind="css: $root.isSelected($parentContext.$index, $index)() ? 'fa-caret-down' : 'fa-caret-right'"></i>
                    <span class="materials" data-bind="visible: materials().length > 0, foreach: materials">
                      <span class="label" data-bind="attr: {title: title}, text: shortName, style: {'background-color': bgColor, 'color': color}"></span>
                    </span>
                    <span data-bind="text: path"/>
                  </p>
                  <div class="progress" data-bind="css: { 'progress-striped active': $root.active_set() == id }">
                    <div data-bind="style: { width: pct_complete() }" class="bar bar-success"></div>
                    <div data-bind="visible: $root.active_set() == id, style: { width: pct_active() }" class="bar active"></div>
                  </div>
                  <div class="repeats">
                    <!-- _vkenabled fixes dynamic form bug on virtual keyboard: https://github.com/xontab/chrome-virtual-keyboard/issues/5 -->
                    <span data-bind="text: (count()-remaining()) + ' /'"></span>
                    <input class="fa fa-text count-box" type="number" data-bind="value: countInput, event: { change: $root.setCount }, attr: {'_vkenabled': false}"></input>
                  </div>
                  <div class="total" data-bind="text: length_completed() + '/' + length()"></div>
                  <div class="accordion-heading-button pull-right">
                    <input type="checkbox" data-bind="checked: selected"></input>
                  </div>
                </div>
            </div>

            <div class="accordion-body collapse" data-bind="css: {'in': $root.isSelected($parentContext.$index, $index)()}">
              <div class="accordion-inner">
                <div class="queue-set-list">
                  <div data-bind="visible: $root.materials().length > 0">
                    <div>Materials:</div>
                    <div class="material_select" data-bind="foreach: new Array($root.extruders() || 0)">
                      <div>
                        <span data-bind="text: '' + $index() + ':'"></span>
                        <select data-bind="value: (set.materials()[$index()] || {}).key, event: {change: (_, evt) => $root.setMaterial($parent, $index(), evt.target.value)}">
                          <option key=""></option>
                          <!-- ko foreach: $root.materials -->
                            <option data-bind="value: value, text: text"></option>
                          <!-- /ko -->
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="hint" data-bind="hidden: $root.materials().length > 0">
                    Hint: Install SpoolManager, add spools, then reload the page to select material types.
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
